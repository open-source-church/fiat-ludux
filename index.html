<!DOCTYPE html>
<html>

<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet"
    type="text/css">
  <link href="https://cdn.jsdelivr.net/npm/quasar@2.6.0/dist/quasar.prod.css" rel="stylesheet" type="text/css">
  <!-- Icons from https://seiyria.com/gameicons-font/ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg-injector/1.1.3/svg-injector.min.js"
    integrity="sha512-LpKoEmPyokcDYSjRJ/7WgybgdAYFsKtCrGC9m+VBwcefe1vHXyUnD9fTQb3nXVJda6ny1J84UR+iBtEYm3OQmQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body>
  <!-- example of injection point where you write your app template -->
  <div id="q-app">
    <q-splitter v-model="splitterModel" style="height: 100vh" :limits="[30, 70]">
      <template v-slot:before>
        <!-- Colonne gauche -->
        <div class="q-pa-sm">
          <q-list bordered class="rounded-borders">
            <!-- Projet -->
            <q-expansion-item expand-separator icon="star" label="Projet" caption="">
              <q-card>
                <q-card-section>
                  <!-- Local projects -->
                  <p class="text-overline">Enregistré localement</p>
                  <div class="row q-mb-sm">
                    <div class="col-11">
                      <q-select dense filled v-model="selectLocalProject" :options="localProjects"
                        label="Projets locaux">
                      </q-select>
                    </div>
                    <div class="col-1 text-center">
                      <q-btn dense round icon="add" @click="createLocalProject"></q-btn>
                    </div>
                  </div>
                  <div class="row q-mb-sm" v-if="selectLocalProject">
                    <div class="col-10">
                      Projet sélectionné: {{ selectLocalProject }}
                    </div>
                    <div class="col-1 text-center">
                      <q-btn dense round flat icon="edit" disable></q-btn>
                    </div>
                    <div class="col-1 text-center">
                      <q-btn dense round flat icon="delete" @click="deleteProject"></q-btn>
                    </div>
                  </div>
                  <p class="text-overline">Projets Open Source Church</p>
                </q-card-section>
              </q-card>
            </q-expansion-item>

            <!-- Paramètres -->
            <q-expansion-item expand-separator icon="settings" label="Paramètres" caption="">
              <q-card>
                <q-card-section>
                  <p class="text-overline">Dimensions de la carte</p>
                  <div class="row justify-center">
                    <div class="col-4">
                      <q-input dense v-model.number="W" type="number" filled hint="largeur">
                      </q-input>
                    </div>
                    <div class="col-1 text-center">×</div>
                    <div class="col-4">
                      <q-input dense v-model.number="H" type="number" filled hint="hauteur">
                      </q-input>
                    </div>
                  </div>
                </q-card-section>
              </q-card>
            </q-expansion-item>

            <!-- Données -->
            <q-expansion-item expand-separator icon="description" label="Données">
              <!-- Custom header -->
              <template v-slot:header>
                <q-item-section avatar>
                  <q-icon name="description" />
                </q-item-section>
                <q-item-section>Données</q-item-section>
                <q-item-section side>
                  <div class="row items-center">
                    <q-btn flat round icon="info" color="info" @click.stop="dialogHelpDonnees">
                    </q-btn>
                  </div>
                </q-item-section>
              </template>
              <!-- Carte -->
              <q-card>
                <q-tabs v-model="panel2tab" dense class="text-grey" active-color="primary" indicator-color="primary"
                  align="justify" narrow-indicator>
                  <q-tab name="csv" label="CSV"></q-tab>
                  <q-tab name="data" label="Data"></q-tab>
                </q-tabs>

                <q-separator></q-separator>

                <q-tab-panels v-model="panel2tab" animated>
                  <q-tab-panel name="csv" class="q-pa-none">
                    <q-input v-model="csvSrc" filled type="textarea" />
                  </q-tab-panel>

                  <q-tab-panel name="data" class="q-pa-none">
                    <q-table :rows="donnees" :columns="tableHeaders" row-key="name">
                    </q-table>
                  </q-tab-panel>
                </q-tab-panels>
              </q-card>
            </q-expansion-item>

            <!-- CSS -->
            <q-expansion-item expand-separator icon="style" label="CSS">
              <q-card>
                <q-card-section class="q-pa-none">
                  <q-input v-model="CSSSrc" filled type="textarea" />
                </q-card-section>
              </q-card>
            </q-expansion-item>

            <!-- Layout -->
            <q-expansion-item icon="format_shapes" label="Layout">
              <!-- Custom header -->
              <template v-slot:header>
                <q-item-section avatar>
                  <q-icon name="format_shapes" />
                </q-item-section>
                <q-item-section>Layout</q-item-section>
                <q-item-section side>
                  <div class="row items-center">
                    <q-btn flat round icon="info" color="info" @click.stop="dialogHelpLayout">
                    </q-btn>
                  </div>
                </q-item-section>
              </template>
              <q-card>
                <!-- Tabs -->
                <q-tabs v-model="panelLayoutTabs" dense class="text-grey" active-color="primary"
                  indicator-color="primary" align="justify" narrow-indicator>
                  <q-tab v-for="type in types" :name="type" :label="type"></q-tab>
                </q-tabs>

                <q-separator></q-separator>

                <q-tab-panels v-model="panelLayoutTabs" animated v-for="type in types">
                  <q-tab-panel :name="type" class="q-pa-none">
                    <q-input v-model="layoutSrcTypes[type]" filled type="textarea" />
                  </q-tab-panel>
                </q-tab-panels>
                <q-separator></q-separator>
                <!-- Original -->
                <q-card-section class="q-pa-none" v-if="types.length == 0">
                  <q-input v-model="layoutSrc" filled type="textarea" />
                </q-card-section>
              </q-card>
            </q-expansion-item>
          </q-list>

          {{ types }}
          <hr>
          
        </div>
      </template>
      <template v-slot:after>
        <!-- Colonne droite -->
        <div class="row no-print">
          <div class="col-10 offset-1">
            <q-slider v-model="zoom" :min="0.1" :max="2" :step="0.1"></q-slider>
          </div>
        </div>
        <div class="feuille" :style="{zoom: zoom}">
          <div class="carte" v-for="carte in cartes" :key="carte" :style="{ width: W + 'mm', height: H + 'mm' }"
            v-html="carte">
          </div>
        </div>

      </template>

    </q-splitter>
  </div>

  <style>
    .carte {
      float: left;
      position: relative;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quasar@2.6.0/dist/quasar.umd.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quasar@2.6.0/dist/lang/fr.umd.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script src="https://cdn.rawgit.com/Keyang/node-csvtojson/d41f44aa/browser/csvtojson.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"
    integrity="sha512-+BMamP0e7wn39JGL8nKAZ3yAQT2dL5oaXWr4ZYlTGkKOaoXM/Yj7c4oy50Ngz5yoUutAG17flueD4F6QpTlPng=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    /**
    * Utility function to add replaceable CSS.
    * https://stackoverflow.com/a/15506705
    * @param {string} styleString
    */
    const updateStyle = (() => {
      const style = document.createElement('style');
      document.head.append(style);
      return (styleString) => style.textContent = styleString;
    })();
    // Setting local forage
    localforage.config({
      name: 'Fiat-Ludus',
      storeName: 'projets'
    })
    // Et on lance vue
    const app = Vue.createApp({
      setup() {
        return {}
      },
      data() {
        return {
          // UI things
          splitterModel: 40,
          panel2tab: "csv",
          panelLayoutTabs: "",
          // CSV un exemple
          csvSrc: `Type,Icone,Texte, N
Titre, , GrattiCartes
Règles,,"**Règles**

*⇒* À deux, en petit groupe, lors d’une cérémonie d’adieu, etc. pour susciter des occasions de se remercier.

*⇒* Lors d’un événement de longue durée, distribuer les cartes aux participant·e·s, qui peuvent se les échanger quand les occasions se présentent.


<span class='credits'>**Crédits**
:CC-BY: *www.holygames.ch*
Adapté de <i>Thanker Cards</i> de Alexandre Quach (#OSG 703)
</span>"
Carte,direction-signs,"Grace à toi,, j’ai changé d’avis sur un sujet important", 2
Carte,crossroad,"Grâce à toi,, j’ai pu prendre une décision difficile", 2
Carte,honeycomb,"Grâce à toi,, j’ai découvert quelque chose qui va améliorer ma vie"
Carte,trail,"Grâce à toi,, j’ai progressé dans un domaine de ma vie"
Carte,battery-pack,"Grâce à toi,, j’ai rechargé mes batteries"`,
          // CSS
          CSSSrc: `.carte{background: purple; padding: 3mm; border-radius:3mm;}
.background { background: white; width: 100%; height: 100%; border-radius:2mm;}
.icone {height: 26mm; width: 26mm; position: absolute; top: 10mm; left: 19mm;}
.icone svg, .icone image {width: inherit; height: inherit}
.icone svg path {fill:purple;}
.texte{color: purple; position: relative; top: 40mm; width: inherit; padding: 0 5mm; text-align:center; font-size: 5mm; line-height: 1;}
.titre-texte {font-size: 9mm; color: white; top:59mm;}
.titre-icone {display: block; width: 40mm; top: 10mm; left: 13mm; position: absolute;}
.regle.texte {top: 3mm; font-size: 4mm; text-align: left;}
.credits {font-size: 3.3mm;}`,
          // Layout
          layoutSrc: "",
          layoutSrcTypes: {
            Titre: `<img class="titre-icone" src="https://i.ibb.co/k4CVVc7/logo-cube-seul-white.png">
<div class="titre-texte texte">%Texte%</div>`,
            Carte: `<div class="background">
<div class="icone">{{GI:%Icone%}}</div>
<div class="texte">%Texte%</div>
</div>`,
            Règles: `<div class="background">
<div class="regle texte">%Texte%</div>`
          }, // layout by types
          donnees: [], // données extraites du CSV
          tyapes: [], // types extraits des données
          W: 64, // dimensions des cartes
          H: 88,
          zoom: 1, // le zoom de la vue des cartes
          // Enregistrement local
          selectLocalProject: null, // le nom du projet selectionné par le q-select
          localProjects: [], // la liste des projets locaux
        }
      },
      computed: {
        cartes() {
          // On crée plusieurs cartes pour celles qui ont une valeur N
          var data = this.donnees.flatMap(e => Array(parseInt(e.N) || 1).fill(e))
          return data.map(d => {
            // Remplace les valeurs des données CSV: %Nom%
            if (d.Type) {
              var lyt = this.layoutSrcTypes[d.Type] || ""
            } else {
              var lyt = this.layoutSrc
            }
            this.headers.forEach(H => lyt = lyt.replaceAll("%" + H + "%", d[H]))

            // Macros: icone de game-icons : {{GI:NOM}}
            // Liste des icones: https://seiyria.com/gameicons-font/
            lyt = lyt.replaceAll(/\{\{GI:(.*?)\}\}/g, '<img src="https://seiyria.com/gameicons-font/svg/$1.svg" onload="SVGInjector(this)"/>')

            return lyt
          }
          )
        },
        headers() {
          content = this.csvSrc.split('\n')
          return content[0].split(',').map(t => _.trim(t))
        },
        CSS() {
          return this.CSSSrc
        },
        tableHeaders() {
          content = this.csvSrc.split('\n')
          header = content[0].split(',').map(t => _.trim(t))
          return header.map(h => {
            return {
              name: h,
              sortable: false,
              label: h,
              align: "left",
              field: h
            }
          })
        },
        types() {
          return _.uniq(this.donnees.map(d => d.Type)).filter(d => d)
        },
        // Une variable pour les unifier tous
        singleJSON() {
          return {
            params: {
              H: this.H,
              W: this.W
            },
            CSS: this.CSSSrc,
            Layout: this.layoutSrc,
            LayoutTypes: _.cloneDeep(this.layoutSrcTypes),
            CSV: this.csvSrc
          }
        }
      },
      watch: {
        // On met à jour les données quand le CSV change
        csvSrc: {
          immediate: true,
          async handler() {
            this.donnees = await csv().fromString(this.csvSrc).then((result) => result)
          },
        },
        // On met à jour le style des cartes quand le CSS change
        CSS: {
          immediate: true,
          handler() { updateStyle(this.CSS) }
        },
        // Une variable pour les contrôler toutes
        singleJSON() {
          if (this.selectLocalProject) {
            this.saveLocalProject()
          }
        },
        // Le projet local change
        selectLocalProject() {
          var self = this
          if (this.selectLocalProject) {
            localforage.getItem(this.selectLocalProject)
              .then(val => {
                self.H = val.params.H
                self.W = val.params.W
                self.CSSSrc = val.CSS
                self.layoutSrc = val.Layout
                self.layoutSrcTypes = _.cloneDeep(val.LayoutTypes),
                  self.csvSrc = val.CSV
              })
          } else {
            self.H = 88
            self.W = 64
            self.CSSSrc = ""
            self.layoutSrc = ""
            self.layoutSrcTypes = {}
            self.csvSrc = ""
          }
        }
      },
      mounted() {
        this.updateLocalProjectsList()
      },
      created() {
        this.saveLocalProject = Quasar.debounce(this.saveLocalProject, 1000)
      },
      methods: {
        // Dialogues d'aide
        dialogHelpLayout() {
          var msg = []
          msg.push("Créez le layout en <b>HTML</b>.")
          msg.push(`Vous pouvez utiliser les titres de vos données CSV comme ceci: <code>%Titre%</code>. Les titres détectés dans vos données actuellement sont: <code>${this.headers.join(", ")}</code>.`)
          msg.push("Les maccros suivantes sont aussi disponibles:")
          msg.push("* <code>{{GI:nom}}</code> pour importer une icone de <a href=\"https://seiyria.com/gameicons-font/\" target=\"_blank\">game-icons</a>.")

          Quasar.Dialog.create({
            title: 'Création de layout',
            message: msg.map(t => `<p>${t}</p>`).join("\n"),
            html: true
          })
        },
        dialogHelpDonnees() {
          var msg = []
          msg.push("Entrez les données au format <b>CSV</b>.")
          msg.push(`La première ligne donne le nom des catégories qui pourront être utilisées pour créer les cartes.`)
          msg.push("Certains noms sont reservés pour des effets particuliers:")
          msg.push("* <code>Type</code> permet de créer différents types de cartes, avec leur propre <b>Layout</b> chacune.")
          msg.push("* <code>N</code> permet de créer plusieurs fois la même carte.")

          Quasar.Dialog.create({
            title: 'Données des cartes',
            message: msg.map(t => `<p>${t}</p>`).join("\n"),
            html: true
          })
        },
        saveLocalProject() {
          if (this.selectLocalProject) {
            localforage.setItem(this.selectLocalProject, this.singleJSON)
              .then(() => console.log("...saved"))
          }
        },
        createLocalProject() {
          var self = this
          Quasar.Dialog.create({
            title: 'Nouveau projet local',
            message: "Comment s'appelle votre projet?",
            prompt: {
              model: '',
              type: 'text' // optional
            },
            cancel: true,
            persistent: true
          }).onOk(data => {
            data = data.trim()
            if (data) {
              // On crée un projet vide
              localforage.setItem(data, {
                params: { H: 88, W: 64 },
                CSS: "",
                Layout: "",
                LayoutTypes: {},
                CSV: ""
              })
                // On update la liste des projets
                .then(val => self.updateLocalProjectsList())
                // On sélectionne le projet crée
                .then(v => self.selectLocalProject = data)
            }
          })
        },
        deleteProject() {
          var self = this
          Quasar.Dialog.create({
            title: 'Sûr?',
            message: 'Sûr de vouloir supprimer le projet <b>' + this.selectLocalProject + '</b>',
            cancel: true,
            html: true
          }).onOk(() => {
            localforage.removeItem(self.selectLocalProject)
              .then(() => self.updateLocalProjectsList())
              .then(() => self.selectLocalProject = "")
          })
        },
        updateLocalProjectsList() {
          var self = this
          localforage.keys().then(function (keys) {
            self.localProjects = keys
            console.log("Projets locaux:", keys)
          }).catch(function (err) {
            console.log(err);
          })
        }
      }
    })

    app.use(Quasar)
    Quasar.lang.set(Quasar.lang.fr)
    app.mount('#q-app')

  </script>

  <style>
    @media print {

      .no-print,
      .q-splitter__before,
      .q-splitter__separator {
        display: none !important;
      }

      q-splitter__panel {
        position: absolute;
        left: 0;
      }

      .feuille {
        zoom: 100% !important;
        width: auto;
        height: auto;
      }

      div {
        page-break-inside: avoid;
      }

      .q-splitter {
        height: auto !important;
      }

      body,
      .q-splitter__after,
      .feuille {
        margin: 0px;
        padding: 0px;
      }
    }
  </style>
</body>

</html>